require("source-map-support").install(),module.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=62)}([function(e,t,n){"use strict";n.d(t,"e",function(){return o}),n.d(t,"d",function(){return s}),n.d(t,"a",function(){return a}),n.d(t,"c",function(){return c}),n.d(t,"b",function(){return u}),n.d(t,"g",function(){return l}),n.d(t,"f",function(){return d});var i=n(45),r=n.n(i);class o extends r.a{constructor(e){super(e)}}class s extends o{constructor(e){super(e)}}class a extends s{constructor(e){super(e)}}class c extends o{constructor(e){super(e)}}class u extends o{constructor(e){let t="";for(const[n,i]of e){t+=`\nError on extension loaded from ${n}: ${String(i)}\n`}super(`Reload errors: ${t}`),this.errorsBySourceDir=e}}function l(e,t){return n=>{let i=!0;if(Array.isArray(e)?-1===e.indexOf(n.code)&&-1===e.indexOf(n.errno)||(i=!1):n.code!==e&&n.errno!==e||(i=!1),i)throw n;return t(n)}}function d(e,t){return!(!Array.isArray(e)||-1===e.indexOf(t.code))||t.code===e}},function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(e,t,n){"use strict";n.r(t),n.d(t,"ConsoleStream",function(){return a}),n.d(t,"consoleStream",function(){return c}),n.d(t,"createLogger",function(){return u});var i=n(1),r=n.n(i),o=n(16),s=n.n(o);class a{constructor({verbose:e=!1}={}){r()(this,"verbose",void 0),r()(this,"isCapturing",void 0),r()(this,"capturedMessages",void 0),this.verbose=e,this.isCapturing=!1,this.capturedMessages=[]}format({name:e,msg:t,level:n}){return`${this.verbose?`[${e}][${o.nameFromLevel[n]}] `:""}${t}\n`}makeVerbose(){this.verbose=!0}write(e,{localProcess:t=process}={}){const n=this.verbose?s.a.TRACE:s.a.INFO;if(e.level>=n){const n=this.format(e);this.isCapturing?this.capturedMessages.push(n):t.stdout.write(n)}}startCapturing(){this.isCapturing=!0}stopCapturing(){this.isCapturing=!1,this.capturedMessages=[]}flushCapturedLogs({localProcess:e=process}={}){for(const t of this.capturedMessages)e.stdout.write(t);this.capturedMessages=[]}}const c=new a;function u(e,{createBunyanLog:t=o.createLogger}={}){return t({name:e.replace(/^src\//,""),level:s.a.TRACE,streams:[{type:"raw",stream:c}]})}},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("mz")},function(e,t){e.exports=function(e,t){return Object.create(e,(n=t,Object.getOwnPropertyNames(n).reduce(function(e,t){return e[t]=Object.getOwnPropertyDescriptor(n,t),e},{})));var n}},function(e,t,n){var i,r=n(36),o=n(5)(r.EventEmitter.prototype,{initialize:function(e,t){this.client=e,this.actor=t,this.client.on("message",function(e){e.from==this.actor&&this.emit(e.type,e)}.bind(this))},request:function(e,t,n,i){"function"==typeof t?("function"==typeof n?(i=n,n=t):i=t,t={}):i||(t||(t={}),i=n,n=null),t.to=this.actor,t.type=e,this.client.makeRequest(t,function(e){if(delete e.from,e.error){var t=new Error(e.message);return t.name=e.error,void i(t)}n&&(e=n(e)),i&&i(null,e)})},createJSObject:function(e){if(null!=e)return i||(i=n(37)),"object"==e.type?new i(this.client,e):e},pluck:function(e){return function(t){return t[e]}}});e.exports=o},function(e,t,n){var i=n(1);e.exports=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){i(e,t,n[t])})}return e}},function(e,t){e.exports=require("es6-promisify")},function(e,t){e.exports=require("fs")},function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return h}),n.d(t,"b",function(){return p});var i=n(3),r=n.n(i),o=n(4),s=n(24),a=n.n(s),c=n(25),u=n.n(c),l=n(0),d=n(2);const f=Object(d.createLogger)(e);async function h(e){const t=r.a.join(e,"manifest.json");let n,i;f.debug(`Validating manifest at ${t}`);try{n=await o.fs.readFile(t,{encoding:"utf-8"})}catch(e){throw new l.a(`Could not read manifest.json file at ${t}: ${e}`)}try{i=a()(u()(n),t)}catch(e){throw new l.a(`Error parsing manifest.json at ${t}: ${e}`)}const s=[];if(i.name||s.push('missing "name" property'),i.version||s.push('missing "version" property'),i.applications&&!i.applications.gecko&&s.push('missing "applications.gecko" property'),s.length)throw new l.a(`Manifest at ${t} is invalid: ${s.join("; ")}`);return i}function p(e){return e.applications?e.applications.gecko.id:void 0}}).call(this,"src/util/manifest.js")},function(e,t,n){"use strict";function i(e){return e.isTTY}function r(e,t){e.setRawMode(t)}n.d(t,"a",function(){return i}),n.d(t,"b",function(){return r})},function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return l}),n.d(t,"b",function(){return f}),n.d(t,"c",function(){return h});var i=n(1),r=n.n(i),o=n(51),s=n.n(o),a=n(2),c=n(0);const u=Object(a.createLogger)(e),l=6005;class d{constructor(e){r()(this,"client",void 0),r()(this,"checkedForAddonReloading",void 0),this.client=e,this.checkedForAddonReloading=!1,e.client.on("disconnect",()=>{u.debug('Received "disconnect" from Firefox client')}),e.client.on("end",()=>{u.debug('Received "end" from Firefox client')}),e.client.on("message",e=>{u.debug(`Received message from client: ${JSON.stringify(e)}`)})}disconnect(){this.client.disconnect()}addonRequest(e,t){return new Promise((n,i)=>{this.client.client.makeRequest({to:e.actor,type:t},e=>{if(e.error){const n=`${e.error}: ${e.message}`;u.debug(`Client responded to '${t}' request with error:`,n),i(new c.e(n))}else n(e)})})}installTemporaryAddon(e){return new Promise((t,n)=>{this.client.request("listTabs",(i,r)=>i?n(new c.e(`Remote Firefox: listTabs() error: ${i}`)):r.addonsActor?void this.client.client.makeRequest({to:r.addonsActor,type:"installTemporaryAddon",addonPath:e},i=>{if(i.error)return n(new c.e("installTemporaryAddon: Error: "+`${i.error}: ${i.message}`));u.debug(`installTemporaryAddon: ${JSON.stringify(i)}`),u.info(`Installed ${e} as a temporary add-on`),t(i)}):(u.debug("listTabs returned a falsey addonsActor: "+`${r.addonsActor}`),n(new c.c("This is an older version of Firefox that does not provide an add-ons actor for remote installation. Try Firefox 49 or higher."))))})}getInstalledAddon(e){return new Promise((e,t)=>{this.client.request("listAddons",(n,i)=>{n?t(new c.e(`Remote Firefox: listAddons() error: ${n}`)):e(i.addons)})}).then(t=>{for(const n of t)if(n.id===e)return n;throw u.debug(`Remote Firefox has these addons: ${t.map(e=>e.id)}`),new c.e("The remote Firefox does not have your extension installed")})}async checkForAddonReloading(e){if(this.checkedForAddonReloading)return e;{const t=await this.addonRequest(e,"requestTypes");if(-1===t.requestTypes.indexOf("reload")){const e=JSON.stringify(t.requestTypes);throw u.debug(`Remote Firefox only supports: ${e}`),new c.d("This Firefox version does not support add-on reloading. Re-run with --no-reload")}return this.checkedForAddonReloading=!0,e}}async reloadAddon(e){const t=await this.getInstalledAddon(e);await this.checkForAddonReloading(t),await this.addonRequest(t,"reload"),process.stdout.write(`\rLast extension reload: ${(new Date).toTimeString()}`),u.debug("\n")}}async function f(e=l,{connectToFirefox:t=s.a}={}){u.debug(`Connecting to Firefox on port ${e}`);const n=await t(e);return u.debug(`Connected to the remote Firefox debugger on port ${e}`),new d(n)}async function h({maxRetries:e=250,retryInterval:t=120,port:n},{connectToFirefox:i=f}={}){return u.debug("Connecting to the remote Firefox debugger"),async function(){var r;for(let o=0;o<=e;o++)try{return await i(n)}catch(e){if(!Object(c.f)("ECONNREFUSED",e))throw u.error(e.stack),e;await new Promise(e=>{setTimeout(e,t)}),r=e,u.debug(`Retrying Firefox (${o}); connection error: ${e}`)}throw u.debug("Connect to Firefox debugger: too many retries"),r}()}}).call(this,"src/firefox/remote.js")},function(e,t){e.exports=require("firefox-profile")},function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return h});var i=n(1),r=n.n(i),o=n(3),s=n.n(o),a=n(47),c=n.n(a),u=n(2);const l=Object(u.createLogger)(e),d=(e,t)=>{const n=s.a.relative(e,t);return!!n&&(".."!==n&&!n.startsWith(`..${s.a.sep}`))};class f{constructor({baseIgnoredPatterns:e=["**/*.xpi","**/*.zip","**/.*","**/.*/**/*","**/node_modules","**/node_modules/**/*"],ignoreFiles:t=[],sourceDir:n,artifactsDir:i}={}){r()(this,"filesToIgnore",void 0),r()(this,"sourceDir",void 0),n=s.a.resolve(n),this.filesToIgnore=[],this.sourceDir=n,this.addToIgnoreList(e),t&&this.addToIgnoreList(t),i&&d(n,i)&&(i=s.a.resolve(i),l.debug(`Ignoring artifacts directory "${i}" `+"and all its subdirectories"),this.addToIgnoreList([i,s.a.join(i,"**","*")]))}resolveWithSourceDir(e){const t=s.a.resolve(this.sourceDir,e);return l.debug(`Resolved path ${e} with sourceDir ${this.sourceDir} `+`to ${t}`),t}addToIgnoreList(e){for(const t of e)if("!"===t.charAt(0)){const e=this.resolveWithSourceDir(t.substr(1));this.filesToIgnore.push(`!${e}`)}else this.filesToIgnore.push(this.resolveWithSourceDir(t))}wantFile(e){const t=this.resolveWithSourceDir(e);return!(c()(t,this.filesToIgnore).length>0)||(l.debug(`FileFilter: ignoring file ${t}`),!1)}}const h=e=>new f(e)}).call(this,"src/util/file-filter.js")},function(e,t){e.exports=require("event-to-promise")},function(e,t){e.exports=require("bunyan")},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"safeFileName",function(){return v}),n.d(t,"getDefaultLocalizedName",function(){return D}),n.d(t,"defaultPackageCreator",function(){return P}),n.d(t,"default",function(){return A});var i=n(3),r=n.n(i),o=n(9),s=n(4),a=n(24),c=n.n(a),u=n(25),l=n.n(u),d=n(15),f=n.n(d),h=n(26),p=n(43),g=n(10),b=n(27),m=n(2),w=n(0),y=n(14);const x=Object(m.createLogger)(e);function v(e){return e.toLowerCase().replace(/[^a-z0-9.-]+/g,"_")}async function D({messageFile:e,manifestData:t}){let n,i,r=t.name;try{i=await s.fs.readFile(e,{encoding:"utf-8"})}catch(t){throw new w.d(`Error reading messages.json file at ${e}: ${t}`)}try{n=c()(l()(i),e)}catch(e){throw new w.d(`Error parsing messages.json ${e}`)}return r=t.name.replace(/__MSG_([A-Za-z0-9@_]+?)__/g,(t,i)=>{if(n[i]&&n[i].message)return n[i].message;throw new w.d(`The locale file ${e} `+`is missing key: ${i}`)}),Promise.resolve(r)}async function P({manifestData:e,sourceDir:t,fileFilter:n,artifactsDir:i,overwriteDest:s,showReadyMessage:a},{eventToPromise:c=f.a}={}){let u;e?(u=Object(g.b)(e),x.debug(`Using manifest id=${u||"[not specified]"}`)):e=await Object(g.a)(t);const l=await Object(p.a)(t,{filter:(...e)=>n.wantFile(...e)});let d=e.name;if(e.default_locale){const n=r.a.join(t,"_locales",e.default_locale,"messages.json");x.debug("Manifest declared default_locale, localizing extension name"),d=await D({messageFile:n,manifestData:e})}const h=v(`${d}-${e.version}.zip`),b=r.a.join(i,h);let m=Object(o.createWriteStream)(b,{flags:"wx"});m.write(l,()=>m.end());try{await c(m,"close")}catch(e){if(!Object(w.f)("EEXIST",e))throw e;if(!s)throw new w.d(`Extension exists at the destination path: ${b}\n`+"Use --overwrite-dest to enable overwriting.");x.info(`Destination exists, overwriting: ${b}`),(m=Object(o.createWriteStream)(b)).write(l,()=>m.end()),await c(m,"close")}return a&&x.info(`Your web extension is ready: ${b}`),{extensionPath:b}}async function A({sourceDir:e,artifactsDir:t,asNeeded:n=!1,overwriteDest:i=!1,ignoreFiles:r=[]},{manifestData:o,createFileFilter:s=y.a,fileFilter:a=s({sourceDir:e,artifactsDir:t,ignoreFiles:r}),onSourceChange:c=h.a,packageCreator:u=P,showReadyMessage:l=!0}={}){const d=n;x.info(`Building web extension from ${e}`);const f=()=>u({manifestData:o,sourceDir:e,fileFilter:a,artifactsDir:t,overwriteDest:i,showReadyMessage:l});await Object(b.a)(t);const p=await f();return d&&(x.info("Rebuilding when files change..."),c({sourceDir:e,artifactsDir:t,onChange:()=>f().catch(e=>{throw x.error(e.stack),e}),shouldWatchFile:(...e)=>a.wantFile(...e)})),p}}.call(this,"src/cmd/build.js")},function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return a});var i=n(49),r=n.n(i),o=n(2);const s=Object(o.createLogger)(e);function a({title:e,message:t,icon:n},{notifier:i=r.a,log:o=s}={}){return new Promise((r,s)=>{i.notify({title:e,message:t,icon:n},(e,t)=>{e?(o.debug(`Desktop notifier error: ${e.message},`+` response: ${t}`),s(e)):r()})})}}).call(this,"src/util/desktop-notifier.js")},function(e,t){e.exports=require("camelcase")},function(e,t,n){"use strict";(function(e){n.d(t,"b",function(){return h}),n.d(t,"a",function(){return p}),n.d(t,"c",function(){return b});var i=n(1),r=n.n(i),o=n(29),s=n.n(o),a=n(0),c=(n(18),n(2)),u=n(14),l=n(11),d=n(26);const f=Object(c.createLogger)(e);async function h(e){switch(e.target){case"firefox-desktop":{const{FirefoxDesktopExtensionRunner:t}=n(80);return new t(e.params)}case"firefox-android":{const{FirefoxAndroidExtensionRunner:t}=n(81);return new t(e.params)}default:throw new a.e(`Unknown target: "${e.target}"`)}}class p{constructor(e){r()(this,"extensionRunners",void 0),r()(this,"desktopNotifications",void 0),this.extensionRunners=e.runners,this.desktopNotifications=e.desktopNotifications}getName(){return"Multi Extension Runner"}async run(){const e=[];for(const t of this.extensionRunners)e.push(t.run());await Promise.all(e)}async reloadAllExtensions(){f.debug("Reloading all reloadable add-ons");const e=[];for(const t of this.extensionRunners){const n=t.reloadAllExtensions().then(()=>({runnerName:t.getName()}),e=>({runnerName:t.getName(),reloadError:e}));e.push(n)}return await Promise.all(e).then(e=>(this.handleReloadResults(e),e))}async reloadExtensionBySourceDir(e){f.debug(`Reloading add-on at ${e}`);const t=[];for(const n of this.extensionRunners){const i=n.reloadExtensionBySourceDir(e).then(()=>({runnerName:n.getName(),sourceDir:e}),t=>({runnerName:n.getName(),reloadError:t,sourceDir:e}));t.push(i)}return await Promise.all(t).then(e=>(this.handleReloadResults(e),e))}registerCleanup(e){const t=[];for(const e of this.extensionRunners)t.push(new Promise(t=>{e.registerCleanup(t)}));Promise.all(t).then(e,e)}async exit(){const e=[];for(const t of this.extensionRunners)e.push(t.exit());await Promise.all(e)}handleReloadResults(e){for(const t of e){const{runnerName:e,reloadError:n,sourceDir:i}=t;if(n instanceof Error){let t="Error occurred while reloading";i&&(t+=` "${i}" `),t+=`on "${e}" - ${n.message}`,f.error(`\n${t}`),f.debug(n.stack),this.desktopNotifications({title:"web-ext run: extension reload error",message:t})}}}}function g({reloadExtension:e,sourceDir:t,artifactsDir:n,ignoreFiles:i,onSourceChange:r=d.a,createFileFilter:o=u.a}){const s=o({sourceDir:t,artifactsDir:n,ignoreFiles:i});return r({sourceDir:t,artifactsDir:n,onChange:()=>e(t),shouldWatchFile:e=>s.wantFile(e)})}function b({artifactsDir:e,extensionRunner:t,ignoreFiles:n,noInput:i=!1,sourceDir:r},{createWatcher:o=g,stdin:a=process.stdin,kill:c=process.kill}={}){const u=!i;u||f.debug("Input has been disabled because of noInput==true");const d=o({reloadExtension:e=>{t.reloadExtensionBySourceDir(e)},sourceDir:r,artifactsDir:e,ignoreFiles:n});if(t.registerCleanup(()=>{d.close(),u&&a.pause()}),u&&Object(l.a)(a)){s.a.emitKeypressEvents(a),Object(l.b)(a,!0);const e="Press R to reload (and Ctrl-C to quit)";Promise.resolve().then(async function(){f.info(e);let n=!1;for(;!n;){const i=await new Promise(e=>{a.once("keypress",(t,n)=>e(n))});i.ctrl&&"c"===i.name?n=!0:"z"===i.name?(Object(l.b)(a,!1),f.info("\nweb-ext has been suspended on user request"),c(process.pid,"SIGTSTP"),f.info(`\nweb-ext has been resumed. ${e}`),Object(l.b)(a,!0)):"r"===i.name&&(f.debug("Reloading installed extensions on user request"),t.reloadAllExtensions())}f.info("\nExiting web-ext on user request"),t.exit()})}}}).call(this,"src/extension-runners/index.js")},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"defaultFirefoxEnv",function(){return $}),n.d(t,"defaultRemotePortFinder",function(){return S}),n.d(t,"run",function(){return q}),n.d(t,"isDefaultProfile",function(){return F}),n.d(t,"configureProfile",function(){return R}),n.d(t,"defaultCreateProfileFinder",function(){return C}),n.d(t,"useProfile",function(){return j}),n.d(t,"createProfile",function(){return O}),n.d(t,"copyProfile",function(){return T}),n.d(t,"installExtension",function(){return N});var i=n(7),r=n.n(i),o=n(9),s=n.n(o),a=n(3),c=n.n(a),u=n(50),l=n.n(u),d=n(13),f=n.n(d),h=n(4),p=n(8),g=n.n(p),b=n(15),m=n.n(b),w=n(31),y=n(0),x=n(28),v=n(10),D=n(2),P=n(12);const A=Object(D.createLogger)(e),k=h.fs.stat.bind(h.fs),$={XPCOM_DEBUG_BREAK:"stack",NS_TRACE_MALLOC_DISABLE_STACKS:"1"};async function S({portToTry:e=P.a,retriesLeft:t=10,connectToFirefox:n=P.b}={}){let i;for(A.debug(`Checking if remote Firefox port ${e} is available`);t>=0;){try{i=await n(e),A.debug(`Remote Firefox port ${e} is in use `+`(retries remaining: ${t})`)}catch(t){if(Object(y.f)("ECONNREFUSED",t))return e;throw t}i.disconnect(),e++,t--}throw new y.e("Too many retries on port search")}async function q(e,{fxRunner:t=l.a,findRemotePort:n=S,firefoxBinary:i,binaryArgs:o}={}){A.debug(`Running Firefox with profile at ${e.path()}`);const s=await n(),a=await t({binary:i,"binary-args":o,"no-remote":!0,listen:s,foreground:!0,profile:e.path(),env:r()({},process.env,$),verbose:!0}),c=a.process;return A.debug(`Executing Firefox binary: ${a.binary}`),A.debug(`Firefox args: ${a.args.join(" ")}`),c.on("error",e=>{throw A.error(`Firefox error: ${e}`),e}),A.info("Use --verbose or open Tools > Web Developer > Browser Console to see logging"),c.stderr.on("data",e=>{A.debug(`Firefox stderr: ${e.toString().trim()}`)}),c.stdout.on("data",e=>{A.debug(`Firefox stdout: ${e.toString().trim()}`)}),c.on("close",()=>{A.debug("Firefox closed")}),{firefox:c,debuggerPort:s}}const E=["default","dev-edition-default"];async function F(e,t=f.a.Finder,n=h.fs.stat){if(E.includes(e))return!0;const i=t.locateUserDirectory(),r=c.a.join(i,"profiles.ini");try{await n(r)}catch(e){if(Object(y.f)("ENOENT",e))return A.debug(`profiles.ini not found: ${e}`),!1;throw e}const o=new t(i),s=g()(o.readProfiles,o);await s();const a=c.a.normalize(c.a.join(c.a.resolve(e),c.a.sep));for(const t of o.profiles)if(E.includes(t.Name)||"1"===t.Default){let n;if(t.Name===e)return!0;if(n="1"===t.IsRelative?c.a.join(i,t.Path,c.a.sep):c.a.join(t.Path,c.a.sep),c.a.normalize(n)===a)return!0}return!1}function R(e,{app:t="firefox",getPrefs:n=x.b,customPrefs:i={}}={}){const r=n(t);if(Object.keys(r).forEach(t=>{e.setPreference(t,r[t])}),Object.keys(i).length>0){const t=JSON.stringify(i,null,2);A.info(`Setting custom Firefox preferences: ${t}`),Object.keys(i).forEach(t=>{e.setPreference(t,i[t])})}return e.updatePreferences(),Promise.resolve(e)}function C({userDirectoryPath:e,FxProfile:t=f.a}={}){const n=new t.Finder(e),i=g()(n.readProfiles,n),r=g()(n.getPath,n);return async e=>{try{if(await i(),0!==n.profiles.filter(t=>t.Name===e).length)return await r(e)}catch(e){if(!Object(y.f)("ENOENT",e))throw e;A.warn("Unable to find Firefox profiles.ini")}}}async function j(e,{app:t,configureThisProfile:n=R,isFirefoxDefaultProfile:i=F,customPrefs:r={},createProfileFinder:o=C}={}){if(await i(e))throw new y.d("Cannot use --keep-profile-changes on a default profile"+` ("${e}")`+" because web-ext will make it insecure and unsuitable for daily use.\nSee https://github.com/mozilla/web-ext/issues/1005");let s;const a=o();if(await Object(w.a)(e))A.debug(`Using profile directory "${e}"`),s=e;else if(A.debug(`Assuming ${e} is a named profile`),!(s=await a(e)))throw new y.d(`The request "${e}" profile name `+"cannot be resolved to a profile path");const c=new f.a({destinationDirectory:s});return await n(c,{app:t,customPrefs:r})}async function O({app:e,configureThisProfile:t=R,customPrefs:n={}}={}){const i=new f.a;return await t(i,{app:e,customPrefs:n})}async function T(e,{app:t,configureThisProfile:n=R,copyFromUserProfile:i=d.copyFromUserProfile,customPrefs:r={}}={}){const o=g()(f.a.copy),s=g()(i);try{let i;return await Object(w.a)(e)?(A.debug(`Copying profile directory from "${e}"`),i=await o({profileDirectory:e})):(A.debug(`Assuming ${e} is a named profile`),i=await s({name:e})),n(i,{app:t,customPrefs:r})}catch(t){throw new y.e(`Could not copy Firefox profile from ${e}: ${t}`)}}async function N({asProxy:e=!1,manifestData:t,profile:n,extensionPath:i,asyncFsStat:r=k}){if(!n.extensionsDir)throw new y.e("profile.extensionsDir was unexpectedly empty");try{await r(n.extensionsDir)}catch(e){if(!Object(y.f)("ENOENT",e))throw e;A.debug(`Creating extensions directory: ${n.extensionsDir}`),await h.fs.mkdir(n.extensionsDir)}const o=Object(v.b)(t);if(!o)throw new y.d("An explicit extension ID is required when installing to a profile (applications.gecko.id not found in manifest.json)");if(e){if(A.debug(`Installing as an extension proxy; source: ${i}`),!await Object(w.a)(i))throw new y.e("proxy install: extensionPath must be the extension source "+`directory; got: ${i}`);const e=c.a.join(n.extensionsDir,`${o}`),t=s.a.createWriteStream(e);return t.write(i),t.end(),await m()(t,"close")}{const e=s.a.createReadStream(i),t=c.a.join(n.extensionsDir,`${o}.xpi`),r=s.a.createWriteStream(t);return A.debug(`Installing extension from ${i} to ${t}`),e.pipe(r),await Promise.all([m()(e,"close"),m()(r,"close")])}}}.call(this,"src/firefox/index.js")},function(e,t){e.exports=require("os")},function(e,t,n){"use strict";t.a={build:async function(e,t){const{default:i}=n(17);return i(e,t)},lint:async function(e,t){const{default:i}=n(63);return i(e,t)},run:async function(e,t){const{default:i}=n(64);return i(e,t)},sign:async function(e,t){const{default:i}=n(82);return i(e,t)},docs:async function(e,t){const{default:i}=n(83);return i(e,t)}}},function(e,t){e.exports=require("parse-json")},function(e,t){e.exports=require("strip-json-comments")},function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return u});var i=n(41),r=n.n(i),o=n(42),s=n.n(o),a=n(2);const c=Object(a.createLogger)(e);function u({sourceDir:e,artifactsDir:t,onChange:n,shouldWatchFile:i}){const o=new r.a;return n=s()(n,1e3,!0),o.on("change",e=>{!function({artifactsDir:e,onChange:t,filePath:n,shouldWatchFile:i}){0!==n.indexOf(e)&&i(n)?(c.debug(`Changed: ${n}`),c.debug(`Last change detection: ${(new Date).toTimeString()}`),t()):c.debug(`Ignoring change to: ${n}`)}({artifactsDir:t,onChange:n,filePath:e,shouldWatchFile:i})}),c.debug(`Watching for file changes in ${e}`),o.watch([],[e],Date.now()),process.on("SIGINT",()=>o.close()),o}}).call(this,"src/watcher.js")},function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return h});var i=n(4),r=n(46),o=n.n(r),s=n(8),a=n.n(s),c=n(0),u=n(2);const l=Object(u.createLogger)(e),d=a()(o.a),f=i.fs.access.bind(i.fs);async function h(e,{asyncMkdirp:t=d,asyncFsAccess:n=f}={}){try{if(!(await i.fs.stat(e)).isDirectory())throw new c.d(`--artifacts-dir="${e}" exists but it is not a directory.`);try{await n(e,i.fs.W_OK)}catch(t){throw Object(c.f)("EACCES",t)?new c.d(`--artifacts-dir="${e}" exists but the user lacks `+"permissions on it."):t}}catch(n){if(Object(c.f)("EACCES",n))throw new c.d(`Cannot access --artifacts-dir="${e}" because the user `+`lacks permissions: ${n}`);if(!Object(c.f)("ENOENT",n))throw n;try{l.debug(`Creating artifacts directory: ${e}`),await t(e)}catch(t){throw Object(c.f)("EACCES",t)?new c.d(`Cannot create --artifacts-dir="${e}" because the `+`user lacks permissions: ${t}`):t}}return e}}).call(this,"src/util/artifacts.js")},function(e,t,n){"use strict";(function(e){n.d(t,"b",function(){return d}),n.d(t,"a",function(){return f});var i=n(7),r=n.n(i),o=n(0),s=n(2);const a=Object(s.createLogger)(e),c=["devtools.debugger.remote-enabled","devtools.debugger.prompt-connection","xpinstall.signatures.required"],u={"browser.dom.window.dump.enabled":!0,"devtools.debugger.remote-enabled":!0,"devtools.debugger.prompt-connection":!1,"extensions.logging.enabled":!1,"extensions.checkCompatibility.nightly":!1,"extensions.update.enabled":!1,"extensions.update.notifyUser":!1,"extensions.enabledScopes":5,"extensions.getAddons.cache.enabled":!1,"extensions.installDistroAddons":!1,"extensions.autoDisableScopes":10,"app.update.enabled":!1,"xpinstall.signatures.required":!1},l={common:u,fennec:{"browser.console.showInPanel":!0,"browser.firstrun.show.uidiscovery":!1,"devtools.remote.usb.enabled":!0},firefox:{"browser.startup.homepage":"about:blank","startup.homepage_welcome_url":"about:blank","startup.homepage_welcome_url.additional":"","devtools.errorconsole.enabled":!0,"devtools.chrome.enabled":!0,"urlclassifier.updateinterval":172800,"browser.safebrowsing.provider.0.gethashURL":"http://localhost/safebrowsing-dummy/gethash","browser.safebrowsing.provider.0.keyURL":"http://localhost/safebrowsing-dummy/newkey","browser.safebrowsing.provider.0.updateURL":"http://localhost/safebrowsing-dummy/update","browser.selfsupport.url":"https://localhost/selfrepair","browser.reader.detectedFirstArticle":!0,"datareporting.policy.firstRunURL":""}};function d(e="firefox"){const t=l[e];if(!t)throw new o.e(`Unsupported application: ${e}`);return r()({},u,t)}function f(e){const t={};for(const n of e){const e=n.split("=");if(e.length<2)throw new o.d(`Incomplete custom preference: "${n}". `+'Syntax expected: "prefname=prefvalue".');const i=e[0];let r=e.slice(1).join("=");if(/[^\w{@}.-]/.test(i))throw new o.d(`Invalid custom preference name: ${i}`);r===`${parseInt(r)}`?r=parseInt(r,10):"true"!==r&&"false"!==r||(r="true"===r),c.includes(i)?a.warn(`'${i}' preference cannot be customized.`):t[`${i}`]=r}return t}}).call(this,"src/firefox/preferences.js")},function(e,t){e.exports=require("readline")},function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return d});var i=n(1),r=n.n(i),o=n(52),s=n.n(o),a=n(8),c=n.n(a),u=n(2);const l=Object(u.createLogger)(e);function d(e){const t=new f;return t.create().then(()=>e(t)).catch(t.errorHandler()).then(t.successHandler())}class f{constructor(){r()(this,"_path",void 0),r()(this,"_removeTempDir",void 0),this._path=void 0,this._removeTempDir=void 0}create(){return c()(s.a.dir,{multiArgs:!0})({prefix:"tmp-web-ext-",unsafeCleanup:!0}).then(e=>{const[t,n]=e;return this._path=t,this._removeTempDir=n,l.debug(`Created temporary directory: ${this.path()}`),this})}path(){if(!this._path)throw new Error("You cannot access path() before calling create()");return this._path}errorHandler(){return e=>{throw this.remove(),e}}successHandler(){return e=>(this.remove(),e)}remove(){this._removeTempDir&&(l.debug(`Removing temporary directory: ${this.path()}`),this._removeTempDir&&this._removeTempDir())}}}).call(this,"src/util/temp-dir.js")},function(e,t,n){"use strict";n.d(t,"a",function(){return o});var i=n(4),r=n(0);function o(e){return i.fs.stat(e).then(e=>e.isDirectory()).catch(Object(r.g)(["ENOENT","ENOTDIR"],()=>!1))}},function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return y}),n.d(t,"c",function(){return x}),n.d(t,"b",function(){return v});var i=n(7),r=n.n(i),o=n(22),s=n.n(o),a=n(3),c=n.n(a),u=n(59),l=n.n(u),d=n(19),f=n.n(d),h=n(60),p=n.n(h),g=n(61),b=n(2),m=n(0);const w=Object(b.createLogger)(e);function y({argv:e,argvFromCLI:t,configObject:n,options:i,configFileName:o}){let s=r()({},e);for(const e of Object.keys(n)){if(f()(e)!==e)throw new m.d(`The config option "${e}" must be `+`specified in camel case: "${f()(e)}"`);if(!Array.isArray(n[e])&&"object"==typeof i[e]&&"object"==typeof n[e]){s=y({argv:s,argvFromCLI:t,configObject:n[e],options:i[e],configFileName:o});continue}const r=p()(e,"-");if("object"!=typeof i[r])throw new m.d(`The config file at ${o} specified `+`an unknown option: "${e}"`);if(void 0===i[r].type)throw new m.e(`Option: ${e} was defined without a type.`);const a="count"===i[r].type?"number":i[r].type,c=Array.isArray(n[e])?"array":typeof n[e];if(c!==a)throw new m.d(`The config file at ${o} specified `+`the type of "${e}" incorrectly as "${c}"`+` (expected type "${a}")`);let u;if(i[r]&&(void 0!==i[r].default?u=i[r].default:"boolean"===a&&(u=!1)),void 0!==t[e]&&t[e]!==u){w.debug(`Favoring CLI: ${e}=${t[e]} over `+`configuration: ${e}=${n[e]}`),s[e]=t[e];continue}s[e]=n[e];const l=i[r].coerce;l&&(w.debug(`Calling coerce() on configured value for ${e}`),s[e]=l(s[e]))}return s}function x(e){const t=c.a.resolve(e);let n;w.debug(`Loading JS config file: "${e}" `+`(resolved to "${t}")`);try{n=l()(t)}catch(e){throw w.debug("Handling error:",e),new m.d(`Cannot read config file: ${t}\n`+`Error: ${e.message}`)}return e.endsWith("package.json")&&(w.debug("Looking for webExt key inside package.json file"),n=n.webExt||{}),0===Object.keys(n).length&&w.debug(`Config file ${t} did not define any options. `+"Did you set module.exports = {...}?"),n}async function v({getHomeDir:e=s.a.homedir}={}){const t=[c.a.join(e(),".web-ext-config.js"),c.a.join(process.cwd(),"package.json"),c.a.join(process.cwd(),"web-ext-config.js")],n=await Promise.all(t.map(async e=>{const t=c.a.resolve(e);return await Object(g.a)(t)?t:void w.debug(`Discovered config "${t}" does not `+"exist or is not readable")})),i=[];return n.forEach(e=>{"string"==typeof e&&i.push(e)}),i}}).call(this,"src/config.js")},function(e,t,n){var i=n(5),r=n(6),o=n(70),s=n(71),a=n(72),c=n(74),u=n(75);function l(e,t){this.initialize(e,t.actor),this.tab=t,this.updateInfo(t),this.on("tabNavigated",this.onTabNavigated.bind(this))}e.exports=l,l.prototype=i(r,{updateInfo:function(e){this.url=e.url,this.title=e.title},get StyleSheets(){return this._StyleSheets||(this._StyleSheets=new u(this.client,this.tab.styleSheetsActor)),this._StyleSheets},get DOM(){return this._DOM||(this._DOM=new a(this.client,this.tab.inspectorActor)),this._DOM},get Network(){return this._Network||(this._Network=new c(this.client,this.tab.consoleActor)),this._Network},get Console(){return this._Console||(this._Console=new o(this.client,this.tab.consoleActor)),this._Console},get Memory(){return this._Memory||(this._Memory=new s(this.client,this.tab.memoryActor)),this._Memory},onTabNavigated:function(e){"start"==e.state?this.emit("before-navigate",{url:e.url}):"stop"==e.state&&(this.updateInfo(e),this.emit("navigate",{url:e.url,title:e.title}))},attach:function(e){this.request("attach",e)},detach:function(e){this.request("detach",e)},reload:function(e){this.request("reload",e)},navigateTo:function(e,t){this.request("navigateTo",{url:e},t)}})},function(e,t){e.exports=require("net")},function(e,t){e.exports=require("git-rev-sync")},function(e,t){e.exports=require("events")},function(e,t,n){n(38);var i=n(5),r=n(6);function o(e,t){this.initialize(e,t.actor),this.obj=t}e.exports=o,o.prototype=i(r,{type:"object",get class(){return this.obj.class},get name(){return this.obj.name},get displayName(){return this.obj.displayName},ownPropertyNames:function(e){this.request("ownPropertyNames",function(e){return e.ownPropertyNames},e)},ownPropertyDescriptor:function(e,t){this.request("property",{name:e},function(e){return this.transformDescriptor(e.descriptor)}.bind(this),t)},ownProperties:function(e){this.request("prototypeAndProperties",function(e){return this.transformProperties(e.ownProperties)}.bind(this),e)},prototype:function(e){this.request("prototype",function(e){return this.createJSObject(e.prototype)}.bind(this),e)},ownPropertiesAndPrototype:function(e){this.request("prototypeAndProperties",function(e){return e.ownProperties=this.transformProperties(e.ownProperties),e.safeGetterValues=this.transformGetters(e.safeGetterValues),e.prototype=this.createJSObject(e.prototype),e}.bind(this),e)},transformProperties:function(e){var t={};for(var n in e)t[n]=this.transformDescriptor(e[n]);return t},transformGetters:function(e){var t={};for(var n in e)t[n]=this.transformGetter(e[n]);return t},transformDescriptor:function(e){return e.value=this.createJSObject(e.value),e},transformGetter:function(e){return{value:this.createJSObject(e.getterValue),prototypeLevel:e.getterPrototypeLevel,enumerable:e.enumerable,writable:e.writable}}})},function(e,t){e.exports=require("js-select")},function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return q});var i=n(7),r=n.n(i),o=n(1),s=n.n(o),a=n(22),c=n.n(a),u=n(3),l=n.n(u),d=n(9),f=n(19),h=n.n(f),p=n(35),g=n.n(p),b=n(40),m=n.n(b),w=n(23),y=n(0),x=n(2),v=n(28),D=n(57),P=n(32);const A=Object(x.createLogger)(e),k="WEB_EXT";class ${constructor(e,{absolutePackageDir:t=process.cwd()}={}){s()(this,"yargs",void 0),s()(this,"commands",void 0),s()(this,"shouldExitProgram",void 0),s()(this,"verboseEnabled",void 0),s()(this,"options",void 0),e=e||process.argv.slice(2);const n=m()(e,t);this.verboseEnabled=!1,this.shouldExitProgram=!0,this.yargs=n,this.yargs.strict(),this.commands={},this.options={}}command(e,t,n,i={}){return this.options[h()(e)]=i,this.yargs.command(e,t,e=>{if(i)return e.demandCommand(0,0,void 0,"This command does not take any arguments").strict().exitProcess(this.shouldExitProgram).env(k).options(i)}),this.commands[e]=n,this}setGlobalOptions(e){return this.options=r()({},this.options,e),Object.keys(e).forEach(t=>{e[t].global=!0,void 0===e[t].demand&&(e[t].demand=!0)}),this.yargs.options(e),this}enableVerboseMode(e,t){this.verboseEnabled||(e.makeVerbose(),A.info("Version:",t),this.verboseEnabled=!0)}async execute(e,{checkForUpdates:t=D.a,systemProcess:n=process,logStream:i=x.consoleStream,getVersion:o=S,applyConfigToArgv:s=P.a,discoverConfigFiles:a=P.b,loadJSConfigFile:u=P.c,shouldExitProgram:d=!0,globalEnv:f="production"}={}){this.shouldExitProgram=d,this.yargs.exitProcess(this.shouldExitProgram);const h=this.yargs.argv,p=h._[0],g=o(e),b=this.commands[p];h.verbose&&this.enableVerboseMode(i,g);let m=r()({},h);try{if(void 0===p)throw new y.d("No sub-command was specified in the args");if(!b)throw new y.d(`Unknown command: ${p}`);"production"===f&&t({version:o(e)});const r=[];if(h.configDiscovery){A.debug("Discovering config files. Set --no-config-discovery to disable");const e=await a();r.push(...e)}else A.debug("Not discovering config files");if(h.config&&r.push(l.a.resolve(h.config)),r.length){const e=r.map(e=>e.replace(process.cwd(),".")).map(e=>e.replace(c.a.homedir(),"~")).join(", ");A.info("Applying config file"+`${1!==r.length?"s":""}: `+`${e}`)}r.forEach(e=>{const t=u(e);m=s({argv:m,argvFromCLI:h,configFileName:e,configObject:t,options:this.options})}),m.verbose&&this.enableVerboseMode(i,g),await b(m,{shouldExitProgram:d})}catch(e){if(e instanceof y.d&&!m.verbose?A.error(`\n${e}\n`):A.error(`\n${e.stack}\n`),e.code&&A.error(`Error code: ${e.code}\n`),A.debug(`Command executed: ${p}`),!this.shouldExitProgram)throw e;n.exit(1)}}}function S(e,{globalEnv:t="production"}={}){if("production"===t){A.debug("Getting the version from package.json");const t=Object(d.readFileSync)(l.a.join(e,"package.json"));return JSON.parse(t).version}return A.debug("Getting version from the git revision"),`${g.a.branch(e)}-${g.a.long(e)}`}function q(e,{getVersion:t=S,commands:n=w.a,argv:i,runOptions:r={}}={}){const o=new $(i,{absolutePackageDir:e});return o.yargs.usage(`Usage: $0 [options] command\n\nOption values can also be set by declaring an environment variable prefixed\nwith $${k}_. For example: $${k}_SOURCE_DIR=/path is the same as\n--source-dir=/path.\n\nTo view specific help for any given command, add the command name.\nExample: $0 --help run.\n`).help("help").alias("h","help").env(k).version(()=>t(e)).demandCommand(1,"You must specify a command").strict(),o.setGlobalOptions({"source-dir":{alias:"s",describe:"Web extension source directory.",default:process.cwd(),requiresArg:!0,type:"string",coerce:l.a.resolve},"artifacts-dir":{alias:"a",describe:"Directory where artifacts will be saved.",default:l.a.join(process.cwd(),"web-ext-artifacts"),normalize:!0,requiresArg:!0,type:"string"},verbose:{alias:"v",describe:"Show verbose output",type:"boolean"},"ignore-files":{alias:"i",describe:'A list of glob patterns to define which files should be ignored. (Example: --ignore-files=path/to/first.js path/to/second.js "**/*.log")',demand:!1,requiresArg:!0,type:"array"},"no-input":{describe:"Disable all features that require standard input",type:"boolean"},config:{alias:"c",describe:"Path to a CommonJS config file to set option defaults",default:void 0,demand:!1,requiresArg:!0,type:"string"},"config-discovery":{describe:"Discover config files in home directory and working directory. Disable with --no-config-discovery.",demand:!1,default:!0,type:"boolean"}}),o.command("build","Create an extension package from source",n.build,{"as-needed":{describe:"Watch for file changes and re-build as needed",type:"boolean"},"overwrite-dest":{alias:"o",describe:"Overwrite destination package if it exists.",type:"boolean"}}).command("sign","Sign the extension so it can be installed in Firefox",n.sign,{"api-key":{describe:"API key (JWT issuer) from addons.mozilla.org",demand:!0,type:"string"},"api-secret":{describe:"API secret (JWT secret) from addons.mozilla.org",demand:!0,type:"string"},"api-url-prefix":{describe:"Signing API URL prefix",default:"https://addons.mozilla.org/api/v3",demand:!0,type:"string"},"api-proxy":{describe:"Use a proxy to access the signing API. Example: https://yourproxy:6000 ",demand:!1,type:"string"},id:{describe:"A custom ID for the extension. This has no effect if the extension already declares an explicit ID in its manifest.",demand:!1,type:"string"},timeout:{describe:"Number of milliseconds to wait before giving up",type:"number"},channel:{describe:"The channel for which to sign the addon. Either 'listed' or 'unlisted'",type:"string"}}).command("run","Run the extension",n.run,{target:{alias:"t",describe:"The extensions runners to enable (e.g. firefox-desktop, firefox-android). Specify this option multiple times to run against multiple targets.",default:"firefox-desktop",demand:!1,type:"array"},firefox:{alias:["f","firefox-binary"],describe:"Path or alias to a Firefox executable such as firefox-bin or firefox.exe. If not specified, the default Firefox will be used. You can specify the following aliases in lieu of a path: firefox, beta, nightly, firefoxdeveloperedition.",demand:!1,type:"string"},"firefox-profile":{alias:"p",describe:"Run Firefox using a copy of this profile. The profile can be specified as a directory or a name, such as one you would see in the Profile Manager. If not specified, a new temporary profile will be created.",demand:!1,type:"string"},"keep-profile-changes":{describe:"Run Firefox directly in custom profile. Any changes to the profile will be saved.",demand:!1,type:"boolean"},"no-reload":{describe:"Do not reload the extension when source files change",demand:!1,type:"boolean"},"pre-install":{describe:"Pre-install the extension into the profile before startup. This is only needed to support older versions of Firefox.",demand:!1,type:"boolean"},pref:{describe:"Launch firefox with a custom preference (example: --pref=general.useragent.locale=fr-FR). You can repeat this option to set more than one preference.",demand:!1,requiresArg:!0,type:"array",coerce:v.a},"start-url":{alias:["u","url"],describe:"Launch firefox at specified page",demand:!1,requiresArg:!0,type:"array"},"browser-console":{alias:["bc"],describe:"Open the DevTools Browser Console.",demand:!1,type:"boolean"},"adb-bin":{describe:"Specify a custom path to the adb binary",demand:!1,type:"string",requiresArg:!0},"adb-host":{describe:"Connect to adb on the specified host",demand:!1,type:"string",requiresArg:!0},"adb-port":{describe:"Connect to adb on the specified port",demand:!1,type:"string",requiresArg:!0},"adb-device":{alias:["android-device"],describe:"Connect to the specified adb device name",demand:!1,type:"string",requiresArg:!0},"firefox-apk":{describe:"Run a specific Firefox for Android APK. Example: org.mozilla.fennec_aurora",demand:!1,type:"string",requiresArg:!0}}).command("lint","Validate the extension source",n.lint,{output:{alias:"o",describe:"The type of output to generate",type:"string",default:"text",choices:["json","text"]},metadata:{describe:"Output only metadata as JSON",type:"boolean",default:!1},"warnings-as-errors":{describe:"Treat warnings as errors by exiting non-zero for warnings",alias:"w",type:"boolean",default:!1},pretty:{describe:"Prettify JSON output",type:"boolean",default:!1},"self-hosted":{describe:"Your extension will be self-hosted. This disables messages related to hosting on addons.mozilla.org.",type:"boolean",default:!1},boring:{describe:"Disables colorful shell output",type:"boolean",default:!1}}).command("docs","Open the web-ext documentation in a browser",n.docs,{}),o.execute(e,r)}}).call(this,"src/program.js")},function(e,t){e.exports=require("yargs")},function(e,t){e.exports=require("watchpack")},function(e,t){e.exports=require("debounce")},function(e,t,n){"use strict";n.d(t,"a",function(){return s});var i=n(44),r=n.n(i),o=n(8);const s=n.n(o)()(r.a)},function(e,t){e.exports=require("zip-dir")},function(e,t){e.exports=require("es6-error")},function(e,t){e.exports=require("mkdirp")},function(e,t){e.exports=require("multimatch")},function(e,t){e.exports=require("addons-linter")},function(e,t){e.exports=require("node-notifier")},function(e,t){e.exports=require("fx-runner")},function(e,t,n){"use strict";var i=n(65).Promise,r=n(66);e.exports=function(e){return new i(function(t,n){var i=new r;i.connect(e,function(e){e&&n(e),t(i)}),i.on("error",n),i.on("timeout",n)})}},function(e,t){e.exports=require("tmp")},function(e,t,n){"use strict";(function(e){n.d(t,"a",function(){return d});var i=n(1),r=n.n(i),o=n(54),s=n.n(o),a=n(0),c=n(2);const u=Object(c.createLogger)(e);async function l(e){try{return await e()}catch(e){if(Object(a.f)("ENOENT",e)&&e.message.includes("spawn adb"))throw new a.d("No adb executable has been found. You can Use --adb-bin, --adb-host/--adb-port to configure it manually if needed.");throw e}}class d{constructor(e){r()(this,"params",void 0),r()(this,"adb",void 0),r()(this,"adbClient",void 0),r()(this,"artifactsDirMap",void 0),r()(this,"userAbortDiscovery",void 0),this.params=e;const{adb:t,adbBin:n,adbHost:i,adbPort:o}=e;this.adb=t||s.a,this.adbClient=this.adb.createClient({bin:n,host:i,port:o}),this.artifactsDirMap=new Map,this.userAbortDiscovery=!1}runShellCommand(e,t){const{adb:n,adbClient:i}=this;return u.debug(`Run adb shell command on ${e}: ${JSON.stringify(t)}`),l(async()=>await i.shell(e,t).then(n.util.readAll)).then(e=>e.toString())}async discoverDevices(){const{adbClient:e}=this;let t=[];return u.debug("Listing android devices"),(t=await l(async()=>e.listDevices())).map(e=>e.id)}async discoverInstalledFirefoxAPKs(e,t){return u.debug(`Listing installed Firefox APKs on ${e}`),(await this.runShellCommand(e,["pm","list","packages"])).split("\n").map(e=>e.replace("package:","").trim()).filter(e=>t?e===t:e.startsWith("org.mozilla.fennec")||e.startsWith("org.mozilla.firefox"))}async getAndroidVersionNumber(e){const t=(await this.runShellCommand(e,["getprop","ro.build.version.sdk"])).trim(),n=parseInt(t);if(isNaN(n))throw new a.e("Unable to discovery android version on "+`${e}: ${t}`);return n}async ensureRequiredAPKRuntimePermissions(e,t,n){const i={};for(const e of n)i[e]=!1;const r=(await this.runShellCommand(e,["pm","dump",t])).split("\n");for(const e of r)for(const t of n)e.includes(`${t}: granted=true`)&&(i[t]=!0);for(const e of n)if(!i[e])throw new a.d(`Required ${e} has not be granted for ${t}. `+"Please grant them using the Android Settings or using the following adb command:\n"+`\t adb shell pm grant ${t} ${e}\n`)}async amForceStopAPK(e,t){await this.runShellCommand(e,["am","force-stop",t])}async getOrCreateArtifactsDir(e){let t=this.artifactsDirMap.get(e);if(t)return t;if(t=`/sdcard/web-ext-artifacts-${Date.now()}`,"1"!==(await this.runShellCommand(e,`test -d ${t} ; echo $?`)).trim())throw new a.e(`Cannot create artifacts directory ${t} `+`because it exists on ${e}.`);return await this.runShellCommand(e,["mkdir","-p",t]),this.artifactsDirMap.set(e,t),t}async clearArtifactsDir(e){const t=this.artifactsDirMap.get(e);t&&(this.artifactsDirMap.delete(e),u.debug(`Removing ${t} artifacts directory on ${e} device`),await this.runShellCommand(e,["rm","-rf",t]))}async pushFile(e,t,n){const{adbClient:i}=this;u.debug(`Pushing ${t} to ${n} on ${e}`),await l(async()=>{await i.push(e,t,n).then(function(e){return new Promise(t=>{e.on("end",t)})})})}async startFirefoxAPK(e,t,n){const{adbClient:i}=this;u.debug(`Starting ${t} with profile ${n} on ${e}`),await l(async()=>{await i.startActivity(e,{wait:!0,action:"android.activity.MAIN",component:`${t}/.App`,extras:[{key:"args",value:`-profile ${n}`}]})})}setUserAbortDiscovery(e){this.userAbortDiscovery=e}async discoverRDPUnixSocket(e,t,{maxDiscoveryTime:n,retryInterval:i}={}){let r=[];const o=Date.now();for(;0===r.length;){if(this.userAbortDiscovery)throw new a.d("Exiting Firefox Remote Debugging socket discovery on user request");if(Date.now()-o>n)throw new a.e("Timeout while waiting for the Android Firefox Debugger Socket");0===(r=(await this.runShellCommand(e,["cat","/proc/net/unix"])).split("\n").filter(e=>e.trim().endsWith(`${t}/firefox-debugger-socket`))).length&&await new Promise(e=>setTimeout(e,i))}if((r=r.map(e=>e.trim().split(/\s/).pop())).length>1)throw new a.e("Unexpected multiple RDP sockets: "+`${JSON.stringify(r)}`);return r[0]}async setupForward(e,t,n){const{adbClient:i}=this;u.debug(`Configuring ADB forward for ${e}: ${t} -> ${n}`),await l(async()=>{await i.forward(e,n,t)})}}}).call(this,"src/util/adb.js")},function(e,t){e.exports=require("adbkit")},function(e,t){e.exports=require("sign-addon")},function(e,t){e.exports=require("opn")},function(e,t,n){"use strict";n.d(t,"a",function(){return o});var i=n(58),r=n.n(i);function o({version:e,updateNotifier:t=r.a}){t({pkg:{name:"web-ext",version:e},updateCheckInterval:2592e5}).notify()}},function(e,t){e.exports=require("update-notifier")},function(e,t){e.exports=require("require-uncached")},function(e,t){e.exports=require("decamelize")},function(e,t,n){"use strict";n.d(t,"a",function(){return o});var i=n(4),r=n(0);async function o(e,{fileIsReadable:t=(e=>i.fs.access(e,i.fs.constants.R_OK))}={}){try{return await t(e),(await i.fs.stat(e)).isFile()}catch(e){if(Object(r.f)(["EACCES","ENOENT"],e))return!1;throw e}}},function(e,t,n){"use strict";n.r(t);var i=n(39),r=n(23);const o={logger:n(2)};t.default={main:i.a,cmd:r.a,util:o}},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"default",function(){return a});var i=n(48),r=n(2),o=n(14);const s=Object(r.createLogger)(e);function a({artifactsDir:e,boring:t,ignoreFiles:n,metadata:r,output:a,pretty:c,sourceDir:u,selfHosted:l,verbose:d,warningsAsErrors:f},{createLinter:h=i.createInstance,createFileFilter:p=o.a,shouldExitProgram:g=!0}={}){const b=p({sourceDir:u,ignoreFiles:n,artifactsDir:e});return s.debug(`Running addons-linter on ${u}`),h({config:{logLevel:d?"debug":"fatal",stack:Boolean(d),pretty:c,warningsAsErrors:f,metadata:r,output:a,boring:t,selfHosted:l,shouldScanFile:e=>b.wantFile(e),_:[u]},runAsBinary:g}).run()}}.call(this,"src/cmd/lint.js")},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"default",function(){return h});var i=n(7),r=n.n(i),o=n(17),s=n(18),a=n(21),c=n(12),u=n(2),l=n(10),d=n(20);const f=Object(u.createLogger)(e);async function h({artifactsDir:e,browserConsole:t=!1,pref:n,firefox:i,firefoxProfile:u,keepProfileChanges:h=!1,ignoreFiles:p,noInput:g=!1,noReload:b=!1,preInstall:m=!1,sourceDir:w,startUrl:y,target:x,adbBin:v,adbHost:D,adbPort:P,adbDevice:A,firefoxApk:k},{buildExtension:$=o.default,desktopNotifications:S=s.a,firefoxApp:q=a,firefoxClient:E=c.c,reloadStrategy:F=d.c,MultiExtensionRunner:R=d.a,getValidatedManifest:C=l.a}={}){f.info(`Running web extension from ${w}`),m&&(f.info("Disabled auto-reloading because it's not possible with --pre-install"),b=!0);const j=n,O=[],T={extensions:[{sourceDir:w,manifestData:await C(w)}],keepProfileChanges:h,startUrl:y,desktopNotifications:S};if(!x||0===x.length||x.includes("firefox-desktop")){const e=r()({},T,{firefoxBinary:i,profilePath:u,customPrefs:j,browserConsole:t,preInstall:m,firefoxApp:q,firefoxClient:E}),n=await Object(d.b)({target:"firefox-desktop",params:e});O.push(n)}if(x&&x.includes("firefox-android")){const e=r()({},T,{profilePath:u,customPrefs:j,browserConsole:t,preInstall:m,firefoxApk:k,adbDevice:A,adbHost:D,adbPort:P,adbBin:v,firefoxApp:q,firefoxClient:E,desktopNotifications:s.a,buildSourceDir:(e,t)=>$({sourceDir:e,ignoreFiles:p,asNeeded:!1,artifactsDir:t},{showReadyMessage:!1})}),n=await Object(d.b)({target:"firefox-android",params:e});O.push(n)}const N=new R({desktopNotifications:S,runners:O});return await N.run(),b?f.info("Automatic extension reloading has been disabled"):(f.info("The extension will reload if any source file changes"),F({extensionRunner:N,sourceDir:w,artifactsDir:e,ignoreFiles:p,noInput:g})),N}}.call(this,"src/cmd/run.js")},function(e,t){e.exports=require("es6-promise")},function(e,t,n){e.exports=n(67)},function(e,t,n){var i=n(5),r=n(6),o=n(68),s=n(33),a=n(76),c=n(78),u=n(79);function l(e){var t=new o(e);t.on("error",this.onError.bind(this)),t.on("end",this.onEnd.bind(this)),t.on("timeout",this.onTimeout.bind(this)),this.initialize(t,"root")}e.exports=l,l.prototype=i(r,{connect:function(e,t,n){"function"==typeof e&&(n=e,e=6e3,t="localhost"),"function"==typeof t&&(n=t,t="localhost"),this.client.connect(e,t,n),this.client.expectReply(this.actor,function(e){})},disconnect:function(){this.client.disconnect()},onError:function(e){this.emit("error",e)},onEnd:function(){this.emit("end")},onTimeout:function(){this.emit("timeout")},selectedTab:function(e){this.request("listTabs",function(e){var t=e.tabs[e.selected];return new s(this.client,t)}.bind(this),e)},listTabs:function(e){this.request("listTabs",function(t,n){if(t)return e(t);if(n.simulatorWebappsActor){new u(this.client,n.simulatorWebappsActor).listApps(e)}else{var i=n.tabs.map(function(e){return new s(this.client,e)}.bind(this));e(null,i)}}.bind(this))},getWebapps:function(e){this.request("listTabs",function(t,n){if(t)return e(t);var i=new a(this.client,n);e(null,i)}.bind(this))},getDevice:function(e){this.request("listTabs",function(t,n){if(t)return e(t);var i=new c(this.client,n);e(null,i)}.bind(this))},getRoot:function(e){this.request("listTabs",function(t,n){if(t)return e(t);if(!n.consoleActor)return e("No root actor being available.");var i=new s(this.client,n);e(null,i)}.bind(this))}})},function(e,t,n){var i=n(34),r=n(36),o=n(5);n(69);e.exports=a;var s={tabNavigated:"tabNavigated",styleApplied:"styleApplied",propertyChange:"propertyChange",networkEventUpdate:"networkEventUpdate",networkEvent:"networkEvent",propertyChange:"propertyChange",newMutations:"newMutations",appOpen:"appOpen",appClose:"appClose",appInstall:"appInstall",appUninstall:"appUninstall",frameUpdate:"frameUpdate",tabListChanged:"tabListChanged"};function a(e){this.options=e||{},this.incoming=new Buffer(""),this._pendingRequests=[],this._activeRequests={}}a.prototype=o(r.EventEmitter.prototype,{connect:function(e,t,n){this.client=i.createConnection({port:e,host:t}),this.client.on("connect",n),this.client.on("data",this.onData.bind(this)),this.client.on("error",this.onError.bind(this)),this.client.on("end",this.onEnd.bind(this)),this.client.on("timeout",this.onTimeout.bind(this))},disconnect:function(){this.client&&this.client.end()},makeRequest:function(e,t){if(this.log("request: "+JSON.stringify(e).green),!e.to){var n=e.type||"";throw new Error(n+" request packet has no destination.")}this._pendingRequests.push({to:e.to,message:e,callback:t}),this._flushRequests()},_flushRequests:function(){this._pendingRequests=this._pendingRequests.filter(function(e){return!!this._activeRequests[e.to]||(this.sendMessage(e.message),this.expectReply(e.to,e.callback),!1)}.bind(this))},sendMessage:function(e){if(!e.to)throw new Error("No actor specified in request");if(!this.client)throw new Error("Not connected, connect() before sending requests");var t=JSON.stringify(e);t=new Buffer(t).length+":"+t,this.client.write(t)},expectReply:function(e,t){if(this._activeRequests[e])throw Error("clashing handlers for next reply from "+uneval(e));this._activeRequests[e]=t},handleMessage:function(e){if(!e.from){if(e.error)throw new Error(e.message);throw new Error("Server didn't specify an actor: "+JSON.stringify(e))}if(e.type in s||!this._activeRequests[e.from]){if(e.type)return this.log("unsolicited event: ".grey+JSON.stringify(e).grey),void this.emit("message",e);throw new Error("Unexpected packet from actor "+e.from+JSON.stringify(e))}this.log("response: "+JSON.stringify(e).yellow);var t=this._activeRequests[e.from];delete this._activeRequests[e.from],t(e),this._flushRequests()},onData:function(e){for(this.incoming=Buffer.concat([this.incoming,e]);this.readMessage(););},readMessage:function(){var e=this.incoming.toString().indexOf(":");if(e<0)return!1;var t=parseInt(this.incoming.slice(0,e));if(this.incoming.length-(e+1)<t)return this.log("no complete response yet".grey),!1;this.incoming=this.incoming.slice(e+1);var n,i=this.incoming.slice(0,t);this.incoming=this.incoming.slice(t);try{n=JSON.parse(i.toString())}catch(e){throw new Error("Couldn't parse packet from server as JSON "+e+", message:\n"+i)}return this.handleMessage(n),!0},onError:function(e){var t=e.code?e.code:e;this.log("connection error: ".red+t.red),this.emit("error",e)},onEnd:function(){this.log("connection closed by server".red),this.emit("end")},onTimeout:function(){this.log("connection timeout".red),this.emit("timeout")},log:function(e){this.options.log&&console.log(e)}})},function(e,t){e.exports=require("colors")},function(e,t,n){var i=n(38),r=n(5),o=n(6);n(37);function s(e,t){this.initialize(e,t),this.on("consoleAPICall",this.onConsoleAPI.bind(this)),this.on("pageError",this.onPageError.bind(this))}e.exports=s,s.prototype=r(o,{types:["PageError","ConsoleAPI"],startListening:function(e){this.request("startListeners",{listeners:this.types},e)},stopListening:function(e){this.request("stopListeners",{listeners:this.types},e)},onConsoleAPI:function(e){var t=this.transformConsoleCall(e.message);this.emit("console-api-call",t)},onPageError:function(e){this.emit("page-error",e.pageError)},getCachedLogs:function(e){var t={messageTypes:this.types};this.request("getCachedMessages",t,function(e){return i(e,".messages > *").update(this.transformConsoleCall.bind(this)),e.messages}.bind(this),e)},clearCachedLogs:function(e){this.request("clearMessagesCache",e)},evaluateJS:function(e,t){this.request("evaluateJS",{text:e},function(e){return i(e,".result, .exception").update(this.createJSObject.bind(this))}.bind(this),t)},transformConsoleCall:function(e){return i(e,".arguments > *").update(this.createJSObject.bind(this))}})},function(e,t,n){var i=n(5),r=n(6);function o(e,t){this.initialize(e,t)}e.exports=o,o.prototype=i(r,{measure:function(e){this.request("measure",function(t,n){e(t,n)})}})},function(e,t,n){var i=n(5),r=n(6),o=n(73);function s(e,t){this.initialize(e,t),this.walker=null}function a(e,t){this.initialize(e,t.actor),this.root=new o(e,this,t.root)}function c(e,t){this.initialize(e,t.actor)}e.exports=s,s.prototype=i(r,{document:function(e){this.walkerRequest("document",function(t,n){if(t)return e(t);var i=new o(this.client,this.walker,n.node);e(null,i)}.bind(this))},documentElement:function(e){this.walkerRequest("documentElement",function(t,n){var i=new o(this.client,this.walker,n.node);e(t,i)}.bind(this))},querySelector:function(e,t){this.document(function(n,i){if(n)return t(n);i.querySelector(e,t)})},querySelectorAll:function(e,t){this.document(function(n,i){if(n)return t(n);i.querySelectorAll(e,t)})},getComputedStyle:function(e,t){this.styleRequest("getComputed",{node:e.actor},this.pluck("computed"),t)},getUsedFontFaces:function(e,t,n){var i={node:e.actor,includePreviews:t.includePreviews,previewText:t.previewText,previewFontSize:t.previewFontSize};this.styleRequest("getUsedFontFaces",i,this.pluck("fontFaces"),n)},getFontPreview:function(e,t,n){this.styleRequest("getFontPreview",{node:e.actor,font:t},n)},walkerRequest:function(e,t,n){this.getWalker(function(i,r){r.request(e,t,n)})},getWalker:function(e){if(this.walker)return e(null,this.walker);this.request("getWalker",function(t,n){this.walker=new a(this.client,n.walker),e(t,this.walker)}.bind(this))},styleRequest:function(e,t,n,i){this.getStyle(function(r,o){if(r)throw r;o.request(e,t,n,i)})},getStyle:function(e){if(this.style)return e(null,this.style);this.request("getPageStyle",function(t,n){this.style=new c(this.client,n.pageStyle),e(t,this.style)}.bind(this))}}),a.prototype=i(r,{}),c.prototype=i(r,{})},function(e,t,n){var i=n(5),r=n(6);function o(e,t,n){this.initialize(e,n.actor),this.walker=t,this.getNode=this.getNode.bind(this),this.getNodeArray=this.getNodeArray.bind(this),this.getNodeList=this.getNodeList.bind(this),t.on("newMutations",function(e){}),["nodeType","nodeName","namespaceURI","attrs"].forEach(function(e){this[e]=n[e]}.bind(this))}function s(e,t,n){this.client=e,this.walker=t,this.actor=n.actor,this.length=n.length}e.exports=o,o.prototype=i(r,{getAttribute:function(e){for(var t in this.attrs){var n=this.attrs[t];if(n.name==e)return n.value}},setAttribute:function(e,t,n){var i=[{attributeName:e,newValue:t}];this.request("modifyAttributes",{modifications:i},n)},parentNode:function(e){this.parents(function(t,n){if(t)return e(t);var i=null;n.length&&(i=n[0]),e(null,i)})},parents:function(e){this.nodeRequest("parents",this.getNodeArray,e)},children:function(e){this.nodeRequest("children",this.getNodeArray,e)},siblings:function(e){this.nodeRequest("siblings",this.getNodeArray,e)},nextSibling:function(e){this.nodeRequest("nextSibling",this.getNode,e)},previousSibling:function(e){this.nodeRequest("previousSibling",this.getNode,e)},querySelector:function(e,t){this.nodeRequest("querySelector",{selector:e},this.getNode,t)},querySelectorAll:function(e,t){this.nodeRequest("querySelectorAll",{selector:e},this.getNodeList,t)},getUniqueSelector:function(e){this.request("getUniqueSelector",e)},innerHTML:function(e){this.nodeRequest("innerHTML",function(e){return e.value},e)},outerHTML:function(e){this.nodeRequest("outerHTML",function(e){return e.value},e)},remove:function(e){this.nodeRequest("removeNode",function(e){return new o(this.client,this.walker,e.nextSibling)}.bind(this),e)},highlight:function(e){this.nodeRequest("highlight",e)},release:function(e){this.nodeRequest("releaseNode",e)},getNode:function(e){return e.node?new o(this.client,this.walker,e.node):null},getNodeArray:function(e){return e.nodes.map(function(e){return new o(this.client,this.walker,e)}.bind(this))},getNodeList:function(e){return new s(this.client,this.walker,e.list)},nodeRequest:function(e,t,n,i){i||(i=n,n=t,t={}),t.node=this.actor,this.walker.request(e,t,n,i)}}),s.prototype=i(r,{items:function(e,t,n){"function"==typeof e?(n=e,e=0,t=this.length):"function"==typeof t&&(n=t,t=this.length),this.request("items",{start:e,end:t},this.getNodeArray.bind(this),n)},getNodeArray:function(e){return e.nodes.map(function(e){return new o(this.client,this.walker,e)}.bind(this))}})},function(e,t,n){var i=n(5),r=n(6);function o(e,t){this.initialize(e,t),this.on("networkEvent",this.onNetworkEvent.bind(this))}function s(e,t){this.initialize(e,t.actor),this.event=t,this.on("networkEventUpdate",this.onUpdate.bind(this))}e.exports=o,o.prototype=i(r,{types:["NetworkActivity"],startLogging:function(e){this.request("startListeners",{listeners:this.types},e)},stopLogging:function(e){this.request("stopListeners",{listeners:this.types},e)},onNetworkEvent:function(e){var t=new s(this.client,e.eventActor);this.emit("network-event",t)},sendHTTPRequest:function(e,t){this.request("sendHTTPRequest",{request:e},function(e){return new s(this.client,e.eventActor)}.bind(this),t)}}),s.prototype=i(r,{get url(){return this.event.url},get method(){return this.event.method},get isXHR(){return this.event.isXHR},getRequestHeaders:function(e){this.request("getRequestHeaders",e)},getRequestCookies:function(e){this.request("getRequestCookies",this.pluck("cookies"),e)},getRequestPostData:function(e){this.request("getRequestPostData",e)},getResponseHeaders:function(e){this.request("getResponseHeaders",e)},getResponseCookies:function(e){this.request("getResponseCookies",this.pluck("cookies"),e)},getResponseContent:function(e){this.request("getResponseContent",e)},getEventTimings:function(e){this.request("getEventTimings",e)},onUpdate:function(e){var t={requestHeaders:"request-headers",requestCookies:"request-cookies",requestPostData:"request-postdata",responseStart:"response-start",responseHeaders:"response-headers",responseCookies:"response-cookies",responseContent:"response-content",eventTimings:"event-timings"}[e.updateType];delete e.updateType,this.emit(t,e)}})},function(e,t,n){var i=n(5),r=n(6);function o(e,t){this.initialize(e,t)}function s(e,t){this.initialize(e,t.actor),this.sheet=t,this.on("propertyChange",this.onPropertyChange.bind(this))}function a(e,t){this.initialize(e,t.actor),this.rule=t,this.on("matchesChange",function(e){this.emit("matches-change",e.matches)}.bind(this))}function c(e,t){console.log("source",t),this.initialize(e,t.actor),this.source=t}e.exports=o,o.prototype=i(r,{getStyleSheets:function(e){this.request("getStyleSheets",function(e){return e.styleSheets.map(function(e){return new s(this.client,e)}.bind(this))}.bind(this),e)},addStyleSheet:function(e,t){this.request("addStyleSheet",{text:e},function(e){return new s(this.client,e.styleSheet)}.bind(this),t)}}),s.prototype=i(r,{get href(){return this.sheet.href},get disabled(){return this.sheet.disabled},get ruleCount(){return this.sheet.ruleCount},onPropertyChange:function(e){this.sheet[e.property]=e.value,this.emit(e.property+"-changed",e.value)},toggleDisabled:function(e){this.request("toggleDisabled",function(t,n){if(t)return e(t);this.sheet.disabled=n.disabled,e(null,n.disabled)}.bind(this))},getOriginalSources:function(e){this.request("getOriginalSources",function(e){return null===e.originalSources?[]:e.originalSources.map(function(e){return new c(this.client,e)}.bind(this))}.bind(this),e)},getMediaRules:function(e){this.request("getMediaRules",function(e){return e.mediaRules.map(function(e){return new a(this.client,e)}.bind(this))}.bind(this),e)},update:function(e,t){this.request("update",{text:e,transition:!0},t)},getText:function(e){this.request("getText",this.pluck("text"),e)}}),a.prototype=i(r,{get mediaText(){return this.rule.mediaText},get matches(){return this.rule.matches}}),c.prototype=i(r,{get url(){return this.source.url},getText:function(e){this.request("getText",this.pluck("text"),e)}})},function(e,t,n){var i=n(5),r=n(6),o=n(33),s=n(9),a=n(77).spawn;e.exports=u;var c=20480;function u(e,t){this.initialize(e,t.webappsActor)}u.prototype=i(r,{watchApps:function(e){this.request("watchApps",e)},unwatchApps:function(e){this.request("unwatchApps",e)},launch:function(e,t){this.request("launch",{manifestURL:e},t)},close:function(e,t){this.request("close",{manifestURL:e},t)},getInstalledApps:function(e){this.request("getAll",function(t,n){t?e(t):e(null,n.apps)})},listRunningApps:function(e){this.request("listRunningApps",function(t,n){t?e(t):e(null,n.apps)})},getApp:function(e,t){this.request("getAppActor",{manifestURL:e},function(e,n){if(e)t(e);else{var i=new o(this.client,n.actor);t(null,i)}}.bind(this))},installHosted:function(e,t){this.request("install",{appId:e.appId,metadata:e.metadata,manifest:e.manifest},function(e,n){e||n.error?t(e||n.error):t(null,n.appId)})},_upload:function(e,t){this.request("uploadPackage",function(t,n){var i=n.actor;s.readFile(e,function(e,t){r(i,t)})});var n=this,i=0;function r(e,o){for(var s=i++*c,a=Math.min(s+c,o.length),u="";s<a;s++)u+=String.fromCharCode(o[s]);var l={to:e,type:"chunk",chunk:u};n.client.makeRequest(l,function(i){i.error?t(i):s<o.length?setTimeout(r,0,e,o):function(e){var i={to:e,type:"done"};n.client.makeRequest(i,function(i){i.error?t(i):t(null,e,function(e){var t={to:e,type:"remove"};n.client.makeRequest(t,function(){})}.bind(null,e))})}(e)})}},installPackaged:function(e,t,n){this._upload(e,function(e,i,r){this.request("install",{appId:t,upload:i},function(e,t){e?n(e):(n(null,t.appId),r())})}.bind(this))},installPackagedWithADB:function(e,t,n){var i=this;function r(){a("adb",["push",e,"/data/local/tmp/b2g/"+t+"/application.zip"],{stdio:"inherit"}).on("close",o)}function o(){i.request("install",{appId:t},function(e,t){e?n(e):n(null,t.appId)})}a("adb",["shell","mkdir -p /data/local/tmp/b2g/"+t],{stdio:"inherit"}).on("close",r)},uninstall:function(e,t){this.request("uninstall",{manifestURL:e},t)}})},function(e,t){e.exports=require("child_process")},function(e,t,n){var i=n(5),r=n(6);function o(e,t){this.initialize(e,t.deviceActor)}e.exports=o,o.prototype=i(r,{getDescription:function(e){this.request("getDescription",function(t,n){if(t)return e(t);e(null,n.value)})},getRawPermissionsTable:function(e){this.request("getRawPermissionsTable",function(t,n){if(t)return e(t);e(null,n.value.rawPermissionsTable)})}})},function(e,t,n){var i=n(5),r=n(6),o=n(33);function s(e,t){this.initialize(e,t)}e.exports=s,s.prototype=i(r,{listApps:function(e){this.request("listApps",function(e){var t=[];for(var n in e.apps){var i=e.apps[n];t.push(new o(this.client,i))}return t}.bind(this),e)}})},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"FirefoxDesktopExtensionRunner",function(){return c});var i=n(1),r=n.n(i),o=n(0),s=(n(21),n(12),n(2));const a=Object(s.createLogger)(e);class c{constructor(e){r()(this,"cleanupCallbacks",void 0),r()(this,"params",void 0),r()(this,"profile",void 0),r()(this,"reloadableExtensions",void 0),r()(this,"remoteFirefox",void 0),r()(this,"runningInfo",void 0),this.params=e,this.reloadableExtensions=new Map,this.cleanupCallbacks=new Set}getName(){return"Firefox Desktop"}async run(){await this.setupProfileDir(),await this.startFirefoxInstance()}async reloadAllExtensions(){const e=this.getName(),t=new Map;for(const e of this.params.extensions){const{sourceDir:n}=e,[i]=await this.reloadExtensionBySourceDir(n);i.reloadError instanceof Error&&t.set(n,i.reloadError)}return t.size>0?[{runnerName:e,reloadError:new o.b(t)}]:[{runnerName:e}]}async reloadExtensionBySourceDir(e){const t=this.getName(),n=this.reloadableExtensions.get(e);if(!n)return[{sourceDir:e,reloadError:new o.e("Extension not reloadable: "+`no addonId has been mapped to "${e}"`),runnerName:t}];try{await this.remoteFirefox.reloadAddon(n)}catch(n){return[{sourceDir:e,reloadError:n,runnerName:t}]}return[{runnerName:t,sourceDir:e}]}registerCleanup(e){this.cleanupCallbacks.add(e)}async exit(){if(!this.runningInfo||!this.runningInfo.firefox)throw new o.e("No firefox instance is currently running");this.runningInfo.firefox.kill()}async setupProfileDir(){const{customPrefs:e,extensions:t,keepProfileChanges:n,preInstall:i,profilePath:r,firefoxApp:o}=this.params;if(r?n?(a.debug(`Using Firefox profile from ${r}`),this.profile=await o.useProfile(r,{customPrefs:e})):(a.debug(`Copying Firefox profile from ${r}`),this.profile=await o.copyProfile(r,{customPrefs:e})):(a.debug("Creating new Firefox profile"),this.profile=await o.createProfile({customPrefs:e})),i)for(const e of t)await o.installExtension({asProxy:!0,extensionPath:e.sourceDir,manifestData:e.manifestData,profile:this.profile})}async startFirefoxInstance(){const{browserConsole:e,extensions:t,firefoxBinary:n,preInstall:i,startUrl:r,firefoxApp:s,firefoxClient:c}=this.params,u=[];if(e&&u.push("-jsconsole"),r){const e=Array.isArray(r)?r:[r];for(const t of e)u.push("--url",t)}if(this.runningInfo=await s.run(this.profile,{firefoxBinary:n,binaryArgs:u}),this.runningInfo.firefox.on("close",()=>{for(const e of this.cleanupCallbacks)try{e()}catch(e){a.error(`Exception on executing cleanup callback: ${e}`)}}),!i){const e=this.remoteFirefox=await c({port:this.runningInfo.debuggerPort});for(const n of t)try{const t=await e.installTemporaryAddon(n.sourceDir).then(e=>e.addon.id);if(!t)throw new o.e("Unexpected missing addonId in the installAsTemporaryAddon result");this.reloadableExtensions.set(n.sourceDir,t)}catch(e){throw e instanceof o.c?(a.debug(`Caught: ${e}`),new o.e("Temporary add-on installation is not supported in this version of Firefox (you need Firefox 49 or higher). For older Firefox versions, use --pre-install")):e}}}}}.call(this,"src/extension-runners/firefox-desktop.js")},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"FirefoxAndroidExtensionRunner",function(){return m});var i=n(1),r=n.n(i),o=n(34),s=n.n(o),a=n(3),c=n.n(a),u=n(29),l=n.n(u),d=n(30),f=n(53),h=(n(18),n(0)),p=(n(21),n(12),n(2)),g=n(11);const b=Object(p.createLogger)(e);class m{constructor(e){r()(this,"params",void 0),r()(this,"adbUtils",void 0),r()(this,"exiting",void 0),r()(this,"selectedAdbDevice",void 0),r()(this,"selectedFirefoxApk",void 0),r()(this,"selectedArtifactsDir",void 0),r()(this,"selectedRDPSocketFile",void 0),r()(this,"selectedTCPPort",void 0),r()(this,"cleanupCallbacks",void 0),r()(this,"adbExtensionsPathBySourceDir",void 0),r()(this,"reloadableExtensions",void 0),r()(this,"remoteFirefox",void 0),this.params=e,this.cleanupCallbacks=new Set,this.adbExtensionsPathBySourceDir=new Map,this.reloadableExtensions=new Map,this.printIgnoredParamsWarnings()}async run(){const{adbBin:e,adbHost:t,adbPort:n,ADBUtils:i=f.a}=this.params;this.adbUtils=new i({adbBin:e,adbHost:t,adbPort:n}),await this.adbDevicesDiscoveryAndSelect(),await this.apkPackagesDiscoveryAndSelect(),await this.adbCheckRuntimePermissions(),await this.adbForceStopSelectedPackage(),await this.adbPrepareProfileDir(),await Promise.all([this.adbStartSelectedPackage(),this.buildAndPushExtensions(),this.adbDiscoveryAndForwardRDPUnixSocket()]),await this.rdpInstallExtensions()}getName(){return"Firefox Android"}async reloadAllExtensions(){const e=this.getName(),t=new Map;for(const e of this.params.extensions){const{sourceDir:n}=e,[i]=await this.reloadExtensionBySourceDir(n);i.reloadError instanceof Error&&t.set(n,i.reloadError)}return t.size>0?[{runnerName:e,reloadError:new h.b(t)}]:[{runnerName:e}]}async reloadExtensionBySourceDir(e){const t=this.getName(),n=this.reloadableExtensions.get(e);if(!n)return[{sourceDir:e,reloadError:new h.e("Extension not reloadable: "+`no addonId has been mapped to "${e}"`),runnerName:t}];try{await this.buildAndPushExtension(e),await this.remoteFirefox.reloadAddon(n)}catch(n){return[{sourceDir:e,reloadError:n,runnerName:t}]}return[{runnerName:t,sourceDir:e}]}registerCleanup(e){this.cleanupCallbacks.add(e)}async exit(){const{adbUtils:e,selectedAdbDevice:t,selectedArtifactsDir:n}=this;this.exiting=!0,await this.adbForceStopSelectedPackage(),n&&(b.debug("Cleaning up artifacts directory on the Android device..."),await e.clearArtifactsDir(t));for(const e of this.cleanupCallbacks)try{e()}catch(e){b.error(e)}}getDeviceProfileDir(){return`${this.selectedArtifactsDir}/profile`}printIgnoredParamsWarnings(){this.params.profilePath&&b.warn("Firefox for Android target does not support custom profile paths."),this.params.keepProfileChanges&&b.warn("Firefox for Android target does not support --keep-profile-changes."),this.params.browserConsole&&b.warn("Firefox for Android target does not support --browser-console option."),this.params.preInstall&&b.warn("Firefox for Android target does not support --pre-install option."),this.params.startUrl&&b.warn("Firefox for Android target does not support --start-url option.")}async adbDevicesDiscoveryAndSelect(){const{adbUtils:e}=this,{adbDevice:t}=this.params;let n=[];if(b.debug("Listing android devices"),0===(n=await e.discoverDevices()).length)throw new h.d("No Android device found through ADB. Make sure the device is connected and USB debugging is enabled.");if(!t){const e=n.map(e=>` - ${e}`).join("\n");throw b.info(`\nAndroid devices found:\n${e}`),new h.d("Select an android device using --android-device=<name>")}const i=n.filter(e=>e===t);if(0===i.length){const e=JSON.stringify(n);throw new h.d(`Android device ${t} was not found in list: ${e}`)}this.selectedAdbDevice=i[0],b.info(`Selected ADB device: ${this.selectedAdbDevice}`)}async apkPackagesDiscoveryAndSelect(){const{adbUtils:e,selectedAdbDevice:t,params:{firefoxApk:n}}=this,i=await e.discoverInstalledFirefoxAPKs(t,n);if(0===i.length)throw new h.d("No Firefox packages were found on the selected Android device");const r=e=>e.map(e=>` - ${e}`).join("\n");if(!n){if(b.info(`\nPackages found:\n${r(i)}`),i.length>1)throw new h.d("Select one of the packages using --firefox-apk");return this.selectedFirefoxApk=i[0],void b.info(`Selected Firefox for Android APK: ${this.selectedFirefoxApk}`)}const o=i.filter(e=>e===n);if(0===o.length){const e=r(o);throw new h.d(`Package ${n} was not found in list: ${e}`)}this.selectedFirefoxApk=o[0],b.debug(`Selected Firefox for Android APK: ${this.selectedFirefoxApk}`)}async adbForceStopSelectedPackage(){const{adbUtils:e,selectedAdbDevice:t,selectedFirefoxApk:n}=this;b.info(`Stopping existing instances of ${n}...`),await e.amForceStopAPK(t,n)}async adbCheckRuntimePermissions(){const{adbUtils:e,selectedAdbDevice:t,selectedFirefoxApk:n}=this;b.debug(`Discovering Android version for ${t}...`);const i=await e.getAndroidVersionNumber(t);if("number"!=typeof i||Number.isNaN(i))throw new h.e(`Invalid Android version: ${i}`);b.debug(`Detected Android version ${i}`),i<23||(b.debug("Checking read/write permissions needed for web-ext"+`on ${n}...`),await e.ensureRequiredAPKRuntimePermissions(t,n,["android.permission.READ_EXTERNAL_STORAGE","android.permission.WRITE_EXTERNAL_STORAGE"]))}async adbPrepareProfileDir(){const{adbUtils:e,selectedAdbDevice:t,selectedFirefoxApk:n,params:{firefoxApp:i}}=this;b.debug(`Preparing a temporary profile for ${n}...`);const r=await i.createProfile({app:"fennec"});this.selectedArtifactsDir=await e.getOrCreateArtifactsDir(t);const o=this.getDeviceProfileDir();await e.runShellCommand(t,["mkdir","-p",o]),await e.pushFile(t,c.a.join(r.profileDir,"user.js"),`${o}/user.js`),b.debug(`Created temporary profile at ${o}.`)}async adbStartSelectedPackage(){const{adbUtils:e,selectedFirefoxApk:t,selectedAdbDevice:n}=this,i=this.getDeviceProfileDir();b.info(`Starting ${t}...`),b.debug(`Using profile ${i}`),await e.startFirefoxAPK(n,t,i)}async buildAndPushExtension(e){const{adbUtils:t,selectedAdbDevice:n,selectedArtifactsDir:i,params:{buildSourceDir:r}}=this;await Object(d.a)(async o=>{const{extensionPath:s}=await r(e,o.path()),a=c.a.basename(s,".zip");let u=this.adbExtensionsPathBySourceDir.get(e);u||(u=`${i}/${a}.xpi`),b.debug(`Uploading ${a} on the android device`),await t.pushFile(n,s,u),b.debug(`Upload completed: ${u}`),this.adbExtensionsPathBySourceDir.set(e,u)})}async buildAndPushExtensions(){for(const e of this.params.extensions){const{sourceDir:t}=e;await this.buildAndPushExtension(t)}}async adbDiscoveryAndForwardRDPUnixSocket(){const{adbUtils:e,selectedAdbDevice:t,selectedFirefoxApk:n,params:{firefoxAndroidTimeout:i}}=this,r=this.params.stdin||process.stdin,{unixSocketDiscoveryRetryInterval:o}=m;let{unixSocketDiscoveryMaxTime:s}=m;"number"==typeof i&&(s=i);const a=(t,n)=>{n.ctrl&&"c"===n.name&&e.setUserAbortDiscovery(!0)};Object(g.a)(r)&&(l.a.emitKeypressEvents(r),Object(g.b)(r,!0),r.on("keypress",a));try{this.selectedRDPSocketFile=await e.discoverRDPUnixSocket(t,n,{maxDiscoveryTime:s,retryInterval:o})}finally{Object(g.a)(r)&&r.removeListener("keypress",a)}b.debug(`RDP Socket File selected: ${this.selectedRDPSocketFile}`);const c=await this.chooseLocalTcpPort();b.info(`You can connect to this Android device on TCP port ${c}`);const u=this.selectedRDPSocketFile.startsWith("@")?`localabstract:${this.selectedRDPSocketFile.substr(1)}`:`localfilesystem:${this.selectedRDPSocketFile}`;await e.setupForward(t,u,`tcp:${c}`),this.selectedTCPPort=c}chooseLocalTcpPort(){return new Promise(e=>{const t=s.a.createServer();t.listen(0,()=>{const n=t.address().port;t.close(),e(n)})})}async rdpInstallExtensions(){const{selectedTCPPort:e,params:{extensions:t,firefoxClient:n}}=this,i=this.remoteFirefox=await n({port:e});i.client.on("end",()=>{this.exiting||(b.info("Exiting the device because Firefox for Android disconnected"),this.exit())});for(const e of t){const{sourceDir:t}=e,n=this.adbExtensionsPathBySourceDir.get(t);if(!n)throw new h.e(`ADB extension path for "${t}" was unexpectedly empty`);const r=await i.installTemporaryAddon(n).then(e=>e.addon.id);if(!r)throw new h.e("Received an empty addonId from "+`remoteFirefox.installTemporaryAddon("${n}")`);this.reloadableExtensions.set(e.sourceDir,r)}}}r()(m,"unixSocketDiscoveryRetryInterval",3e3),r()(m,"unixSocketDiscoveryMaxTime",18e4)}.call(this,"src/extension-runners/firefox-android.js")},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"extensionIdFile",function(){return b}),n.d(t,"default",function(){return m}),n.d(t,"getIdFromSourceDir",function(){return w}),n.d(t,"saveIdToSourceDir",function(){return y});var i=n(3),r=n.n(i),o=n(4),s=n(55),a=n.n(s),c=n(17),u=n(10),l=n(30),d=n(0),f=n(27),h=n(2);const p=Object(h.createLogger)(e),g=o.fs.readFile.bind(o.fs),b=".web-extension-id";function m({apiKey:e,apiProxy:t,apiSecret:n,apiUrlPrefix:i,artifactsDir:r,id:o,ignoreFiles:s=[],sourceDir:h,timeout:g,verbose:b,channel:m},{build:x=c.default,preValidatedManifest:v,signAddon:D=a.a}={}){return Object(l.a)(async function(a){let c;await Object(f.a)(r),c=v||await Object(u.a)(h);const[l,P]=await Promise.all([x({sourceDir:h,ignoreFiles:s,artifactsDir:a.path()},{manifestData:c,showReadyMessage:!1}),w(h)]),A=Object(u.b)(c);if(o&&A)throw new d.d(`Cannot set custom ID ${o} because manifest.json `+`declares ID ${A}`);o&&p.debug(`Using custom ID declared as --id=${o}`),A&&(o=A),!o&&P&&(p.info(`Using previously auto-generated extension ID: ${P}`),o=P),o||p.warn("No extension ID specified (it will be auto-generated)");const k=await D({apiKey:e,apiSecret:n,apiUrlPrefix:i,apiProxy:t,timeout:g,verbose:b,id:o,xpiPath:l.extensionPath,version:c.version,downloadDir:r,channel:m});if(k.id&&await y(h,k.id),!k.success)throw p.info("FAIL"),new d.e("The extension could not be signed");return p.info(`Extension ID: ${k.id}`),p.info("SUCCESS"),k})}async function w(e,t=g){const n=r.a.join(e,b);let i;try{i=await t(n)}catch(e){if(Object(d.f)("ENOENT",e))return void p.debug(`No ID file found at: ${n}`);throw e}let o=i.toString().split("\n");const s=(o=o.filter(e=>{if((e=e.trim())&&!e.startsWith("#"))return e}))[0];if(p.debug(`Found extension ID ${s} in ${n}`),!s)throw new d.d(`No ID found in extension ID file ${n}`);return s}async function y(e,t){const n=r.a.join(e,b);await o.fs.writeFile(n,["# This file was created by https://github.com/mozilla/web-ext","# Your auto-generated extension ID for addons.mozilla.org is:",t.toString()].join("\n")),p.debug(`Saved auto-generated ID ${t} to ${n}`)}}.call(this,"src/cmd/sign.js")},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"url",function(){return a}),n.d(t,"default",function(){return c});var i=n(56),r=n.n(i),o=n(2);const s=Object(o.createLogger)(e),a="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Getting_started_with_web-ext";function c(e,{openUrl:t=r.a}={}){return new Promise((e,n)=>{t(a,t=>{t?(s.debug(`Encountered an error while opening URL ${a}`,t),n(t)):e()})})}}.call(this,"src/cmd/docs.js")}]);
//# sourceMappingURL=web-ext.js.map